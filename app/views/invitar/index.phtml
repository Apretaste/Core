<?php 
	$wwwhttp = $this->di->get('path')['http'];
	if( ! isset($name)) $name = ""; 
	if( ! isset($email)) $email = "";
	if(isset($message)) echo '<div class="alert alert-success" role="alert">Gracias por traer a sus amigos y familia en Cuba a disfrutar la internet. <b>Sus contactos han sido invitados correctamente.</b> Le hemos mandado un email de agradecimiento. Si&eacute;ntase libre de invitar incluso m&aacute;s personas usando este formulario.</div>'; 
?>

<style>
	.control-label {
		font-weight: normal;
		text-transform: uppercase;
		font-size: large;
		margin-top: 30px;
	}
	
	.label-support {
		color: gray;
		font-size: small;
	}
</style>

<div class="row">
	<div class="col-xs-12 text-center">
		<img src="<?= $wwwhttp ?>/images/apretaste.logo.big.transp.png" alt="Logo de Apretaste" style="width:200px;">
		<p class="lead">INVITE A SU GENTE <span style="color:#962F1F;">EN CUBA</span> <br class="hidden-sm hidden-md hidden-lg"> A <a onclick="$('#how').slideDown();" href="#">NAVEGAR POR INTERNET</a></p>
		<p id="how" class="label-support" style="display:none;">Apretaste permite utilizar Google, Wikipedia, Noticias, Redes Sociales y m&aacute;s de 40 otras websites desde Cuba, usando Nauta.</p>
	</div>

	<div class="col-xs-12">
		<form action="<?= $wwwhttp ?>/invitar/process" method="POST" data-toggle="validator" role="form">
			<div class="form-group">
				<label class="control-label" for="name"><b>Paso #1:</b> Escriba su nombre</label>
				<p class="label-support">Usaremos su nombre para firmar la invitaci&oacute;n</p>
				<input required id="name" class="form-control" type="text" name="name" value="<?= $name ?>" placeholder="Periquito Perez"/>
			</div>

			<div class="form-group">
				<label class="control-label" for="email"><b>Paso #2:</b> Escriba su email</label>
				<p class="label-support">Usaremos su email para mandarle una confirmaci&oacute;n</p>
				<input required id="email" class="form-control" type="email" name="email" value="<?= $email ?>" placeholder="yo@gmail.com" data-error="Email invalido"/>
			</div>

			<div id="guest-group" class="form-group">
				<label class="control-label" for="guest"><b>Paso #3:</b> Email del invitado en Cuba</label>
				<p class="label-support">Este es la persona que recibir&aacute; acceso a internet</p>
				<input required id="guest" class="form-control" type="email" name="guest[]" placeholder="invitado@nauta.cu" data-error="Email invalido"/>
			</div>

			<div class="form-group">
				<label class="control-label" for="captcha"><b>Paso #4:</b> Escriba el texto en la imagen</label>
				<p id="error-captcha" class="label-support" style="display:none; color:#A94455;">El texto que escribi&oacute; no es el mismo de la imagen.</p>
				<div class="input-group">
					<input required id="captcha" class="form-control" type="text" name="captcha" style="height: 42px;">
					<span class="input-group-addon" style="padding: 0px;"><img class="rounded" style="margin: 0px;" id="captchaimg" style="margin: 5px;" src="<?= $wwwhttp ?>/invitar/captcha"></span>
					<span class="input-group-btn">
						<button style="height: 42px;" class="btn btn-default" type="button" onclick="$('#captchaimg').attr('src','invitar/captcha?rand='+mt_rand(1,9000));$('#captcha').val('');">
							<span class="glyphicon glyphicon-refresh"></span>
						</button>
					</span>
				</div>
			</div>

			<div class="text-center">
				<button id="submitBtn" class="btn btn-success btn-lg" type="submit" onclick="return checkCaptcha();">Enviar invitaci&oacute;n</button>
			</div>
		</form>
	</div>
</div>

<br/><br/>

<!-- new element that will be created to add new emails -->
<div id="guest-clone" class="form-group" style="display:none;">
	<div class="input-group">
		<input required class="form-control" type="email" name="guest[]" placeholder="Email de otro amigo en Cuba" data-error="Email invalido"/>
		<span class="input-group-btn">
			<button class="btn btn-default btn-remove" type="button" onclick="$(this).parents('.form-group').remove();">
				<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
			</button>
		</span>
	</div>
</div>

<script>
	// return random number for the captcha
	function mt_rand(min,max) {
		var argc=arguments.length;
		if(argc===0) {
			min=0;
			max=2147483647;
		}else if(argc===1) {
			throw new Error('Warning: mt_rand() expects exactly 2 parameters, 1 given');
		}
		return Math.floor(Math.random()*(max-min+1))+min;
	}

	// check if the captcha is valid by Ajax
	function checkCaptcha() {
		// check if the captcha is right
		var ret = false;
		var text = $('#captcha').val();
		$.ajax({
			url: "<?= $wwwhttp ?>/invitar/check?text="+text,
			async: false
		}).done(function(data) {
			ret = $.trim(data) == "true";
			if( ! ret) $('#error-captcha').show();
		});	

		// if right, show loading
		if(ret) {
//			$('#submitBtn').attr("disabled", "disabled"); // @TODO disable provents submmittion
			$('#submitBtn').html("Invitando ...");
		}

		return ret;
	}
</script>